# Key Objects

[_Documentation generated by Documatic_](https://www.documatic.com)

<!---Documatic-section-download.get_plugin_config-start--->
## download.get_plugin_config

<!---Documatic-section-get_plugin_config-start--->
<!---Documatic-block-download.get_plugin_config-start--->
<details>
	<summary><code>download.get_plugin_config</code> code snippet</summary>

```python
def get_plugin_config(config_uri):
    try:
        config_uri_parsed = urlparse(config_uri)
        if config_uri_parsed.scheme in ['https', 'http']:
            url = urlopen(config_uri)
            yaml_data = url.read()
        else:
            with open(config_uri, 'r') as file_data:
                yaml_data = file_data.read()
    except URLError as e:
        print(e)
    try:
        plugin_data = yaml.safe_load(yaml_data)
        return plugin_data['plugins']
    except yaml.YAMLError as e:
        print(e)
```
</details>
<!---Documatic-block-download.get_plugin_config-end--->
<!---Documatic-section-get_plugin_config-end--->

# #
<!---Documatic-section-download.get_plugin_config-end--->

<!---Documatic-section-download.list_plugins-start--->
## download.list_plugins

<!---Documatic-section-list_plugins-start--->
<!---Documatic-block-download.list_plugins-start--->
<details>
	<summary><code>download.list_plugins</code> code snippet</summary>

```python
def list_plugins(plugin_data):
    print('Available plugins:')
    for (name, data) in plugin_data.items():
        print(name, end='')
        if 'default' in data and data['default'] is True:
            print(' [default]')
        else:
            print()
```
</details>
<!---Documatic-block-download.list_plugins-end--->
<!---Documatic-section-list_plugins-end--->

# #
<!---Documatic-section-download.list_plugins-end--->

<!---Documatic-section-download.process_template_strings-start--->
## download.process_template_strings

<!---Documatic-section-process_template_strings-start--->
<!---Documatic-block-download.process_template_strings-start--->
<details>
	<summary><code>download.process_template_strings</code> code snippet</summary>

```python
def process_template_strings(data):
    for (plugin_name, plugin_data) in data.items():
        version = plugin_data['version']
        guid = plugin_data['guid']
        for (key, value) in plugin_data.items():
            if key == 'version':
                continue
            if not isinstance(value, str):
                continue
            data[plugin_name][key] = Template(value).substitute(name=plugin_name, version=version, guid=guid)
    return data
```
</details>
<!---Documatic-block-download.process_template_strings-end--->
<!---Documatic-section-process_template_strings-end--->

# #
<!---Documatic-section-download.process_template_strings-end--->

<!---Documatic-section-download.filter_plugins-start--->
## download.filter_plugins

<!---Documatic-section-filter_plugins-start--->
<!---Documatic-block-download.filter_plugins-start--->
<details>
	<summary><code>download.filter_plugins</code> code snippet</summary>

```python
def filter_plugins(plugin_data, selected_plugins):
    if selected_plugins is None:
        for (name, data) in list(plugin_data.items()):
            if 'default' not in data or data['default'] is not True:
                del plugin_data[name]
    else:
        selected_plugins = selected_plugins.split(',')
        for name in selected_plugins:
            if name not in plugin_data.keys():
                print('ERROR: Unknown plugin specified: {}'.format(name))
                sys.exit(1)
        for (name, data) in list(plugin_data.items()):
            if name not in selected_plugins:
                del plugin_data[name]
    return plugin_data
```
</details>
<!---Documatic-block-download.filter_plugins-end--->
<!---Documatic-section-filter_plugins-end--->

# #
<!---Documatic-section-download.filter_plugins-end--->

<!---Documatic-section-update_plugin_manifest.fetch_fog_config_data-start--->
## update-plugin-manifest.fetch_fog_config_data

<!---Documatic-section-fetch_fog_config_data-start--->
<!---Documatic-block-update_plugin_manifest.fetch_fog_config_data-start--->
<details>
	<summary><code>update_plugin_manifest.fetch_fog_config_data</code> code snippet</summary>

```python
def fetch_fog_config_data(cfg):
    results = {}
    url = urlopen(cfg)
    json_data = url.read()
    plugins = json.loads(json_data)
    for p in plugins['plugins']:
        platform = p['platform']
        guid = p['guid']
        cfg_url = p['update_url']
        update_url = urlopen(cfg_url)
        update_data = update_url.read()
        update = json.loads(update_data)
        version = update['tag_name']
        dl_url = ''
        for a in update['assets']:
            if 'win' in a['name']:
                dl_url = a['browser_download_url']
        if version.startswith('v'):
            version = version[1:]
        results[platform] = {'guid': guid, 'version': version, 'dl_url': dl_url}
        print('Found plugin {} version {}'.format(platform, version))
    return results
```
</details>
<!---Documatic-block-update_plugin_manifest.fetch_fog_config_data-end--->
<!---Documatic-section-fetch_fog_config_data-end--->

# #
<!---Documatic-section-update_plugin_manifest.fetch_fog_config_data-end--->

<!---Documatic-section-download.download_plugins-start--->
## download.download_plugins

<!---Documatic-section-download_plugins-start--->
<!---Documatic-block-download.download_plugins-start--->
<details>
	<summary><code>download.download_plugins</code> code snippet</summary>

```python
def download_plugins(data, dest):
    for (name, data) in data.items():
        version = data['version']
        guid = data['guid']
        url = data['url']
        if 'archive_path' in data:
            archive_path = data['archive_path']
        else:
            archive_path = None
        dest_dir = os.path.join(dest, name + '_' + guid)
        if os.path.isdir(dest_dir):
            with open(os.path.join(dest_dir, 'manifest.json')) as m:
                data = json.load(m)
                existing_version = data['version']
                m.close()
                if version == existing_version:
                    print('NOTICE: Skipping "{}" download, "{}" already exists'.format(name, version))
                    continue
                else:
                    shutil.rmtree(dest_dir)
                    print('Upgrading {} plugin'.format(name))
        print('Downloading "{}" version "{}" ({})'.format(name, version, guid))
        req = Request(url)
        req.add_header('user-agent', 'gog-plugin-downloader/' + __version__)
        plugin_url = urlopen(req)
        plugin_zip = zipfile.ZipFile(BytesIO(plugin_url.read()))
        if not archive_path:
            plugin_zip.extractall(path=dest_dir)
        else:
            tmp_dir = tempfile.TemporaryDirectory(prefix='galaxy-plugin')
            plugin_zip.extractall(path=tmp_dir.name)
            shutil.move(os.path.join(tmp_dir.name, archive_path), dest_dir)
            tmp_dir.cleanup()
```
</details>
<!---Documatic-block-download.download_plugins-end--->
<!---Documatic-section-download_plugins-end--->

# #
<!---Documatic-section-download.download_plugins-end--->

<!---Documatic-section-download.delete_old_plugins-start--->
## download.delete_old_plugins

<!---Documatic-section-delete_old_plugins-start--->
<!---Documatic-block-download.delete_old_plugins-start--->
<details>
	<summary><code>download.delete_old_plugins</code> code snippet</summary>

```python
def delete_old_plugins(data, dest):
    for (name, data) in data.items():
        expected_plugin_dir = name + '_' + data['guid']
        for item in os.listdir(dest):
            full_path = os.path.join(dest, item)
            if not os.path.isdir(full_path):
                continue
            if item == expected_plugin_dir:
                continue
            if item.startswith(name + '_'):
                print('Deleting wrong version "{}" from "{}"'.format(item, dest))
                shutil.rmtree(full_path)
```
</details>
<!---Documatic-block-download.delete_old_plugins-end--->
<!---Documatic-section-delete_old_plugins-end--->

# #
<!---Documatic-section-download.delete_old_plugins-end--->

<!---Documatic-section-update_plugin_manifest.update_plugins_manifest-start--->
## update-plugin-manifest.update_plugins_manifest

<!---Documatic-section-update_plugins_manifest-start--->
<!---Documatic-block-update_plugin_manifest.update_plugins_manifest-start--->
<details>
	<summary><code>update_plugin_manifest.update_plugins_manifest</code> code snippet</summary>

```python
def update_plugins_manifest(data, manifest_file):
    with open(manifest_file, 'r') as file_data:
        yaml_data = file_data.read()
    yaml = ruamel.yaml.YAML()
    yaml.indent(mapping=4, sequence=2, offset=0)
    yaml.preserve_quotes = True
    plugin_data = yaml.load(yaml_data)
    for (plugin, cur_data) in plugin_data['plugins'].items():
        if plugin not in data:
            continue
        cur_guid = cur_data['guid']
        cur_version = cur_data['version']
        cur_url = cur_data['url']
        fog_guid = data[plugin]['guid']
        fog_version = data[plugin]['version']
        fog_url = data[plugin]['dl_url']
        print('Checking manifest for {}'.format(plugin))
        if cur_guid != fog_guid:
            print('   New GUID (old: "{}" new: "{}")'.format(cur_guid, fog_guid))
            plugin_data['plugins'][plugin]['guid'] = fog_guid
        if cur_version != fog_version:
            print('   New Version (old: "{}" new: "{}")'.format(cur_version, fog_version))
            plugin_data['plugins'][plugin]['version'] = fog_version
        if cur_url != fog_url:
            print('   New URL (old: "{}" new: "{}")'.format(cur_url, fog_url))
            plugin_data['plugins'][plugin]['url'] = fog_url
    with open(manifest_file, 'w') as yaml_file:
        yaml.dump(plugin_data, yaml_file)
    for fog_name in data:
        if fog_name not in plugin_data['plugins'].keys():
            print('ERROR: {} not found in plugin manifest!'.format(fog_name))
```
</details>
<!---Documatic-block-update_plugin_manifest.update_plugins_manifest-end--->
<!---Documatic-section-update_plugins_manifest-end--->

# #
<!---Documatic-section-update_plugin_manifest.update_plugins_manifest-end--->

<!---Documatic-section-download.fix_plugin_directories-start--->
## download.fix_plugin_directories

<!---Documatic-section-fix_plugin_directories-start--->
<!---Documatic-block-download.fix_plugin_directories-start--->
<details>
	<summary><code>download.fix_plugin_directories</code> code snippet</summary>

```python
def fix_plugin_directories(dest):
    for existing_dir in os.listdir(dest):
        existing_path = os.path.join(dest, existing_dir)
        if not os.path.isdir(existing_path):
            continue
        try:
            with open(os.path.join(existing_path, 'manifest.json')) as m:
                data = json.load(m)
                platform = data['platform']
                guid = data['guid']
                m.close()
                expected_dir = platform + '_' + guid
                expected_path = os.path.join(dest, expected_dir)
                if existing_path != expected_path:
                    print('NOTICE: Folder should be "{}", but it is named "{}"'.format(expected_dir, existing_dir))
                    if os.path.isdir(expected_path):
                        print('NOTICE: Correct pathed plugin already exists,' + ' deleting extra plugin')
                        shutil.rmtree(existing_path)
                    else:
                        print('NOTICE: Renaming folder to proper name')
                        shutil.move(existing_path, expected_path)
        except (FileNotFoundError, json.decoder.JSONDecodeError, KeyError):
            print('ERROR: Could not read plugin data from {} folder'.format(existing_path))
```
</details>
<!---Documatic-block-download.fix_plugin_directories-end--->
<!---Documatic-section-fix_plugin_directories-end--->

# #
<!---Documatic-section-download.fix_plugin_directories-end--->

[_Documentation generated by Documatic_](https://www.documatic.com)